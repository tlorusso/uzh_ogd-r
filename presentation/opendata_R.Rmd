---
title: "Opendata & R"
subtitle: ""
author: "Thomas Lo Russo"
date: "Universität Zürich </br> `r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: lib/zh.css
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: "16:9"
---
class: middle center

## About me

Research Associate 

Official Statistics & Open Government Data 

Canton of Zurich

#### [open.zh.ch](open.zh.ch/)

#### [statistik.zh.ch](statistik.zh.ch/)

`r icon::fa("twitter")`[@thlorusso](https://twitter.com/thlorusso)

---
# The challenges of data aquisition

- Getting data is a critical step in most research 

- sometimes one of the most difficult and time-consuming steps 

- even when data is accessible not granted that is is easy to find 

- frustrating format variabilities & compatibility issues 

Not only hindering academic research but also the development of innovative data-driven products & services.

---

# Open Data to the rescue

__Open Data can contribute to making data aquisition much less painful__

- Machine readable, freely accessible & published in open formats with open license  

- searchable on open data portals (e.g. [opendata.swiss](https://opendata.swiss/de/) / [data.europa.eu](http://data.europa.eu/) / [opentransportdata.swiss](https://opentransportdata.swiss/en/))

--

Also, there are many ongoing efforts to make it easier to retrieve data directly / automatically from (open) repositories with the same tools that are used for analysis. 

In the case of __R__ this results into a growing number of (open) data-packages and API-wrappers.

Prime example: the __rOpenSci__-initative

<img src="https://avatars3.githubusercontent.com/u/1200269?v=3&s=280" alt="drawing" width="10%"/>

https://ropensci.org/

---
class: center middle

### Data aquisition



???

???


Daten direkt in die Tools bringen, welche Forschende und Entwickler nutzen. Einmal suchen , dann mit demselben Code wiederkehrendè

Data portals help! --> findability and common formats, metadata-standards (DCAT)

But when you can get data directly into your ... even better!

---
# What is `r icon::fa("r-project")`?

- Programming language  
- open source  
- runs on multiple platforms  


The R package - ecosystem comprehends a myriad of packages that extend the functionality of the R language. They range from data-manipulation, data-collection and visualization to modelling, GIS as well as many domain specific applictions.


[Field Guide to the R Ecosystem](https://fg2re.sellorm.com/whatisr.html)


???

R is an open-source programming language. It is run either interactively or by an interpreter from commands saved in text files, or “scripts”. This makes it similar to programming languages like Python or Ruby.

However, R differs from those languages in its primary use case. Though R is becoming increasingly general-purpose, it was originally conceived as an open-source replacement for the statistical programming language ‘S’. As such, R is first and foremost a statistical programming language and, as a result, is widely used in academic data science and statistics programmes around the world.

---
class: inverse, center, middle

<img src="lib/rknife.png" alt="drawing" width="50%"/>

---
With R you can create fully reproducible documents in various formats, books, presentations, blogposts or even build web-applications that let others explore data interactively.

<center><img src="lib/R.png" alt="drawing" width="30%"/></center>

---

# Opendata & R to the rescue

- __R__ (and similar open source software) lowers the barriers and costs to make data analysis __repetable and reproducible__.

- __Open Data__ ensures that everyone can access the same information for free (ideally, in a well structured manner)

--

### Democratization of data & tools for analysis


It is not alway possible to use open data (sensitive data, privacy & security reasons) and open source software (special formats).

But whenever it is possible, their combination allows for __reproducibilty__, __repeatability__ as well as __collaboration on unprecedentend scale__

---
class: inverse centre middle

# R & Open Data 

### Showcase : Real Time Data-Service of popular vote results in the canton Zurich

---
The canton of Zurich provides a web service for real time results on voting sundays.
https://opendata.swiss/de/dataset/echtzeitdaten-am-abstimmungstag

```{r,message=FALSE,warning=FALSE}
library(sf)
library(tidyverse)

# get json via webservice, dataset-description : https://opendata.swiss/de/dataset/echtzeitdaten-am-abstimmungstag
data <- jsonlite::fromJSON("http://www.wahlen.zh.ch/abstimmungen/2016_09_25/viewer_download.php")

# transform nested list into an R-friendly dataframe
data <- data %>% 
  map_dfr(bind_rows) %>% 
  unnest(VORLAGEN)

```

---
Some data preparation...
```{r,message=FALSE,warning=FALSE, message=FALSE, dpi=100, fig.height=2}
#short labels for each vote topic
data$VORLAGE_NAME <- factor(data$VORLAGE_NAME, labels = c("Grüne Wirtschaft", "AHV Plus", "NDG", "Bezahlbare Kinderbetreuung"))

data <-data %>% mutate_at(vars(JA_STIMMEN_ABSOLUT,NEIN_STIMMEN_ABSOLUT,JA_PROZENT,STIMMBETEILIGUNG),as.numeric)

#aggregate results on municipality level
data <-data %>% 
  group_by(BFS,VORLAGE_NAME) %>% 
  summarize(ja_anteil=round(sum(JA_STIMMEN_ABSOLUT,na.rm=T)/sum(JA_STIMMEN_ABSOLUT+NEIN_STIMMEN_ABSOLUT,na.rm=T)*100,1))
```

---

Let's take first look at the distribution of yes-shares of the different voting topics.
```{r, dpi=120, warning=FALSE, message=FALSE}
ggplot(data, aes(x=ja_anteil)) + 
              geom_histogram(fill="steelblue")+
              facet_wrap(~VORLAGE_NAME)+
              scale_x_continuous(limits = c(0, 100),breaks=seq(0,100,25))
```

---

.pull-left[

```{r,message=FALSE,warning=FALSE}
# get municipality-borders shapefile from :
# http://www.web.statistik.zh.ch/cms_basiskarten/gen_Gemeinde_2018/GEN_A4_GEMEINDEN_SEEN_2018_F.zip

#load the municipality boundaries shapefile
gemeinden<- sf::read_sf("GEN_A4_GEMEINDEN_SEEN_2018_F", stringsAsFactors = FALSE) %>% select(BFS,BEZIRK,REGION)

#join geodata to the vote result dataframe
mapdata <- left_join(data,gemeinden, by=c("BFS")) 

#map displaying yes-shares per municpality
map <- ggplot(mapdata)+
  geom_sf(aes(fill=ja_anteil))+
  facet_wrap(~VORLAGE_NAME)
```
]

--

.pull-right[

```{r, dpi=120}
map
```

]

---

.pull-left[

```{r,message=FALSE,warning=FALSE, dpi=125}
mapdata <- inner_join(gemeinden,data, by=c("BFS"))

mapnew <- ggplot(mapdata)+
              geom_sf(aes(fill=ja_anteil),color="white")+
              facet_wrap(~VORLAGE_NAME)+
              coord_sf(datum = NA)+
              labs(fill="Ja (in %)")+
              theme_void()+
              scale_fill_gradient2(midpoint=50)+
              guides(fill = guide_colourbar(barwidth = 0.5, barheight = 10))

```
]

--

.pull-right[

```{r,echo=FALSE, dpi=120}
mapnew
```

]

---

```{r}

glimpse(mapdata)

```

In R, we can store the actual data as well as the needed geo-information in the same dataframe.

---

```{r}
# https://opendata.swiss/de/dataset/bevolkerung-pers
bev <- read.csv("http://www.web.statistik.zh.ch/ogd/data/KANTON_ZUERICH_133.csv", sep=";", encoding="UTF8") %>%
  select(BFS = `ï..BFS_NR`, einwohner=INDIKATOR_VALUE,INDIKATOR_JAHR,GEBIET_NAME) %>% 
  dplyr::filter(INDIKATOR_JAHR==2017 & BFS != 0)

# https://opendata.swiss/de/dataset/nrw-wahleranteil-sp
sp <- read.csv("http://www.web.statistik.zh.ch/ogd/data/KANTON_ZUERICH_124.csv", sep=";", encoding="UTF8") %>%
  select(BFS = `ï..BFS_NR`, sp_anteil=INDIKATOR_VALUE,INDIKATOR_JAHR) %>% 
  dplyr::filter(INDIKATOR_JAHR==2015 & BFS != 0)

# join
plotdata <- mapdata %>% 
            filter(VORLAGE_NAME=="Bezahlbare Kinderbetreuung") %>% 
            left_join(sp, by=c("BFS")) %>% 
            left_join(bev, by=c("BFS")) %>% 
            mutate_at(vars(sp_anteil,einwohner),as.numeric) 
```

---

.pull-left[
```{r,warnings=FALSE}
# devtools::install_github("statistikZH/statR")
library(statR)

plot <- ggplot(plotdata, aes(sp_anteil,ja_anteil, size=einwohner/1000))+
            geom_point(colour="steelblue",alpha=0.8)+
            theme_stat()+
            guides(fill="FALSE")+
            labs(title="Bezahlbare Kinderbetreuung",
                 subtitle="Zustimmung zur VI bezahlbare Kinderbetreuung vs SP-Wähleranteil (NRW 2015)")

```
]

--

.pull-right[
```{r,warnings=FALSE, dpi=120}
plot
```
]

---

```{r,eval=FALSE}
library(mapview)

mapview::mapview(plotdata,zcol="ja_anteil")
```

<center>
```{r,echo=FALSE}
library(mapview)

mapview::mapview(plotdata,zcol="ja_anteil")
```
</center>

---
# Building a Web-App with R

<img src="lib/shiny.jpg" alt="drawing" width="10%"/>

With Shiny, we can build an R powered Web-Application nurtured by the data on opendata.swiss. Shiny Apps let other people run your R-Code interactively without having to code themselfes.

https://statistikzh.shinyapps.io/zhvote/

--
- The app is automatically updated, as soon as a new vote date is listed, via the opendata.swiss [CKAN API](https://handbook.opendata.swiss/support/api.html)
--

- No need to update by hand __before__ votation sundays
--

- Real time data stream __on__ votation sundays
--

- No web development skills required

???

Some basic html / css skills nice to have : customizing! The nice thing with R is that if you know R , it lets you do things as this (building web apps)

---

https://statistikzh.shinyapps.io/swr_zh/

---
# Open Data Resources



https://github.com/ropensci/opendata


---
# This presentation



R does not 

data retrieval reproducible.


R is not only suited for data analysis...

It also lets you 


---

R & Open Data help to make data retrieval (more) reproducible


---
## Resources

https://github.com/ropensci/opendata

https://nceas.github.io/oss-lessons/open-data-in-r/open-data-in-R.html


