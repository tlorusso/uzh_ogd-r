---
title: "Opendata & R"
subtitle: ""
author: "Thomas Lo Russo"
date: "Universität Zürich </br> `r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: lib/zh.css
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: "16:9"
---


# Opendata & R

- __R__ (and similar open source software) lowers the barriers and costs to make data analysis __repetable and reproducible__.

- __Open data__ ensures that everyone can access the same information for free (ideally, in a well structured manner)

--

### __Democratization of data & tools for analysis__

It is not alway possible to use open data, not on everything (sensitive data, privacy / security)

But when possible : unbeatable DUO (reproducibility paradise)

A combination that allows collaboration on unprecedentend scale!

---

# Trust in Government Information

How to ... trust ? 

- Reliability 
- Timeliness
- Traceablity

## OPEN GOVERNMENT DATA

---
class: inverse, center, middle

# What is R ?

<img src="rknife.png" alt="drawing" width="50%"/>

---
# What is R ?

- Programming language
- open source
- runs on multiple platforms

The R package - ecosystem comprehends a myriad of packages ranging from data-manipulation, data-collection, modelling , GIS, visualization, 

---
class: inverse centre middle

# R & Open Data 

### Showcase : Real Time Data-Service of popular vote results in the canton Zurich

---

#Daten in R lesen
```{r,message=FALSE,warning=FALSE}
if (!require(pacman)) install.packages(pacman)

pacman::p_load(sf,tidyverse,ggrepel,statR)

library(tidyverse)
# library(purrr)

# get json via webservice
data <- jsonlite::fromJSON("http://www.wahlen.zh.ch/abstimmungen/2016_09_25/viewer_download.php")

# transform nested list into dataframe
data <- data %>% 
  map_dfr(bind_rows) %>% 
  unnest(VORLAGEN)

```

---

```{r,message=FALSE,warning=FALSE, message=FALSE, dpi=100, fig.height=2}
# install.packages("ggridges")
data$VORLAGE_NAME <- factor(data$VORLAGE_NAME, labels = c("Grüne Wirtschaft", "AHV Plus", "NDG", "Bezahlbare Kinderbetreuung"))

data <-data %>% mutate_at(vars(JA_STIMMEN_ABSOLUT,NEIN_STIMMEN_ABSOLUT,JA_PROZENT,STIMMBETEILIGUNG),as.numeric)

#aggregiere auf Gemeindeebene
data <-data %>% 
  group_by(BFS,VORLAGE_NAME) %>% 
  summarize(ja_anteil=round(sum(JA_STIMMEN_ABSOLUT,na.rm=T)/sum(JA_STIMMEN_ABSOLUT+NEIN_STIMMEN_ABSOLUT,na.rm=T)*100,1))
```

---

```{r}
library(ggridges)

ggplot(data,aes(ja_anteil,VORLAGE_NAME))+
    geom_density_ridges(scale = 0.8, fill="steelblue") + 
    theme_ridges() +
    scale_y_discrete(expand = c(0.01, 0)) + 
    scale_x_continuous(limits = c(0, 100),breaks=seq(0,100,25))+
    labs(x="Ja-Anteil (%)", y="Vorlage")
```

---

.pull-left[

```{r,message=FALSE,warning=FALSE}

# get shapefile from here
# http://www.web.statistik.zh.ch/cms_basiskarten/gen_Gemeinde_2018/GEN_A4_GEMEINDEN_SEEN_2018_F.zip

#Gemeindeshapes
gemeinden<- sf::read_sf("GEN_A4_GEMEINDEN_SEEN_2018_F", stringsAsFactors = FALSE)

#join municipality-infos to points
mapdata <- left_join(data,gemeinden, by=c("BFS")) 

map <- ggplot(mapdata)+
  geom_sf(aes(fill=ja_anteil))+
  facet_wrap(~VORLAGE_NAME)

```
]

--

.pull-right[

```{r, dpi=120}
map
```

]

---

.pull-left[

```{r,message=FALSE,warning=FALSE, dpi=125}

#Labels - Kurzbezeichnung 
mapdata <- inner_join(gemeinden,data, by=c("BFS"))


mapnew <- ggplot(mapdata)+
              geom_sf(aes(fill=ja_anteil),color="white")+
              facet_wrap(~VORLAGE_NAME)+
              coord_sf(datum = NA)+
              labs(fill="Ja (in %)")+
              theme_void()+
              scale_fill_gradient2(midpoint=50)+
              guides(fill = guide_colourbar(barwidth = 0.5, barheight = 10))

```
]

--

.pull-right[

```{r,echo=FALSE, dpi=120}
mapnew
```

]

---

```{r}
# https://opendata.swiss/de/dataset/bevolkerung-pers
bev <- read.csv("http://www.web.statistik.zh.ch/ogd/data/KANTON_ZUERICH_133.csv", sep=";", encoding="UTF8") %>%
  select(BFS = `ï..BFS_NR`, einwohner=INDIKATOR_VALUE,INDIKATOR_JAHR,GEBIET_NAME) %>% 
  dplyr::filter(INDIKATOR_JAHR==2017 & BFS != 0)

# https://opendata.swiss/de/dataset/nrw-wahleranteil-sp
sp <- read.csv("http://www.web.statistik.zh.ch/ogd/data/KANTON_ZUERICH_124.csv", sep=";", encoding="UTF8") %>%
  select(BFS = `ï..BFS_NR`, sp_anteil=INDIKATOR_VALUE,INDIKATOR_JAHR) %>% 
  dplyr::filter(INDIKATOR_JAHR==2015 & BFS != 0)

# join
plotdata <- data %>% 
            filter(VORLAGE_NAME=="Bezahlbare Kinderbetreuung") %>% 
            left_join(sp, by=c("BFS")) %>% 
            left_join(bev, by=c("BFS")) %>% 
            mutate_at(vars(sp_anteil,einwohner),as.numeric) %>% 
            as.data.frame()
```

---

.pull-left[
```{r,warnings=FALSE}

library(statR)

plot <- ggplot(plotdata, aes(sp_anteil,ja_anteil, size=einwohner/1000))+
            geom_point(colour="steelblue",alpha=0.8)+
            theme_stat()+
            guides(fill="FALSE")+
            labs(title="Bezahlbare Kinderbetreuung",
                 subtitle="Zustimmung zur VI bezahlbare Kinderbetreuung vs SP-Wähleranteil (NRW 2015)")

```
]

--

.pull-right[
```{r,warnings=FALSE, dpi=120}
plot
```
]

---
# Building a Web-App with R

With Shiny, we can build a R powered Web-Application nurtured by the data on opendata.swiss. 

- The app is automatically updated, as soon as a new vote date is available, via [CKAN API](https://handbook.opendata.swiss/support/api.html)
--
- No need to update by hand __before__ votation sundays
--
- Real time data stream __on__ votation sundays


<img src="shiny.jpg" alt="drawing" width="20%"/>

---






